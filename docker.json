{
    "variables": {
      "aws_access_key": "",
      "aws_secret_key": ""
    },
    "builders": [
      {
        "type": "docker",
        "image": "ubuntu:18.04",
        "commit": "true",
        "pull": "true",
        "changes": [
          "ENTRYPOINT [\"python\"]",  
          "CMD [\"main.py\"]"
        ]
      }
    ],
    "provisioners": [
      {
        "type": "file",
        "source": "files/",
        "destination": "/tmp"
      },
      {
        "type": "shell",
        "environment_vars": [
          "ENV={{ user `environment` }}",
          "EMAIL={{ user `email` }}"
        ],
        "inline": [
          "sleep 30",
          "apt-get update -y",
          "DEBIAN_FRONTEND=noninteractive apt install -y tzdata",
          "apt-get install software-properties-common -y",
          "apt-add-repository ppa:ansible/ansible",
          "apt-get update -y",
          "apt install -y wget",
          "apt install  y apt-utils",     
          "apt install -y python",
          "apt install -y python-dev",
          "apt install -y ansible",

        ]
      },
      {
        "type": "ansible-local",
        "playbook_file": "./ansible/playbook.yml",
        "extra_arguments": [
          "--extra-vars",
          "ENV={{ user `environment` }}",
          "--extra-vars",
          "EMAIL={{ user `email` }}",
          "--extra-vars",
          "EFS={{ user `efs` }}",
          "--extra-vars",
          "SIGNALFX={{ user `signalfx` }}"
         ]
      }
    ],
    "post-processors": [
      [
        {
          "type": "docker-tag",
          "repository": "{{user `ecr_repository`}}",
          "tag": "{{user `tag`}}"
        },
        {
          "type": "docker-push",
          "ecr_login": "true",
          "login_username": "{{user `login_user`}}",
          "login_password": "{{user `login_password`}}",
          "login_server": "{{user `login_server`}}"
        },
        {
          "type": "docker-tag",
          "repository": "{{user `repository`}}",
          "tag": "{{user `tag`}}"
        },
        {
          "type": "docker-push",
          "login": "true",
          "login_username": "{{user `login_user`}}",
          "login_password": "{{user `login_password`}}"
        }
      ]
    ]
  }
  